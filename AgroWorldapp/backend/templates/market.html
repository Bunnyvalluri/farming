{% extends "base.html" %}

{% block content %}
<div class="container" style="padding-top: 100px;">
  <h2 style="text-align: center; margin-bottom: 2rem;"><i class="fa-solid fa-chart-line"></i> Real-Time Mandi Prices
  </h2>

  <div
    style="background: white; padding: 2rem; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); text-align: center; margin-bottom: 2rem;">
    <p style="color: #666; margin-bottom: 1rem;">Select your state and commodity to see the latest Mandi prices.</p>

    <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
      <select id="stateSelect" style="padding: 0.8rem; border-radius: 8px; border: 1px solid #ddd; width: 200px;">
        <option value="Maharashtra">Maharashtra</option>
        <option value="Punjab">Punjab</option>
        <option value="Uttar Pradesh">Uttar Pradesh</option>
        <option value="Andhra Pradesh">Andhra Pradesh</option>
        <option value="Telangana">Telangana</option>
      </select>
      <select id="cropSelect" style="padding: 0.8rem; border-radius: 8px; border: 1px solid #ddd; width: 200px;">
        <option value="Wheat">Wheat</option>
        <option value="Rice">Rice</option>
        <option value="Cotton">Cotton</option>
        <option value="Soybean">Soybean</option>
        <option value="Corn">Corn</option>
      </select>
      <button onclick="fetchPrices()" class="btn">Check Prices</button>
    </div>
  </div>

  <!-- Table to display dynamic market data -->
  <div
    style="background: white; border-radius: 12px; padding: 2rem; box-shadow: 0 4px 6px rgba(0,0,0,0.05); overflow-x: auto;">
    <table style="width: 100%; border-collapse: collapse; min-width: 600px;">
      <thead>
        <tr style="background: #f8fafc; text-align: left;">
          <th style="padding: 1rem; border-bottom: 2px solid #e2e8f0;">Market / Mandi</th>
          <th style="padding: 1rem; border-bottom: 2px solid #e2e8f0;">Commodity</th>
          <th style="padding: 1rem; border-bottom: 2px solid #e2e8f0;">Quality/Variety</th>
          <th style="padding: 1rem; border-bottom: 2px solid #e2e8f0;">Min Price (₹/Quintal)</th>
          <th style="padding: 1rem; border-bottom: 2px solid #e2e8f0;">Max Price (₹/Quintal)</th>
          <th style="padding: 1rem; border-bottom: 2px solid #e2e8f0;">Trend</th>
        </tr>
      </thead>
      <tbody id="priceTableBody">
        <!-- Data populated by JS -->
      </tbody>
    </table>
  </div>
</div>

<script>
  function fetchPrices() {
    const state = document.getElementById('stateSelect').value;
    const crop = document.getElementById('cropSelect').value;
    const tbody = document.getElementById('priceTableBody');

    // Simulating highly requested real-world Mandi price behaviour via mock real data.
    tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding: 2rem;"><i class="fa-solid fa-spinner fa-spin"></i> Fetching live APMC data...</td></tr>`;

    // Timeout to simulate API call latency
    setTimeout(() => {
      const basePrice = {
        "Wheat": 2200, "Rice": 3100, "Cotton": 7000, "Soybean": 5500, "Corn": 2000
      }[crop];

      // Generating random but realistic prices around the base price
      const generateMandiData = (mandiName) => {
        const minP = Math.floor(basePrice * (0.9 + Math.random() * 0.1));
        const maxP = Math.floor(basePrice * (1.1 + Math.random() * 0.1));
        const trend = Math.random() > 0.5 ? '<span style="color: #059669"><i class="fa-solid fa-arrow-trend-up"></i> Up</span>' : '<span style="color: #ef4444"><i class="fa-solid fa-arrow-trend-down"></i> Down</span>';
        return `
                <tr>
                    <td style="padding: 1rem; border-bottom: 1px solid #f1f5f9; font-weight: 500;">${mandiName} APMC</td>
                    <td style="padding: 1rem; border-bottom: 1px solid #f1f5f9;">${crop}</td>
                    <td style="padding: 1rem; border-bottom: 1px solid #f1f5f9;">FAQ / A-Grade</td>
                    <td style="padding: 1rem; border-bottom: 1px solid #f1f5f9; color: #475569;">₹${minP}</td>
                    <td style="padding: 1rem; border-bottom: 1px solid #f1f5f9; font-weight: bold;">₹${maxP}</td>
                    <td style="padding: 1rem; border-bottom: 1px solid #f1f5f9;">${trend}</td>
                </tr>
                `;
      };

      const mandis = [`${state} Central`, `${state} North`, `${state} East`];
      let html = '';
      mandis.forEach(m => html += generateMandiData(m));

      tbody.innerHTML = html;
      showToast('Market prices updated successfully.', 'success');
    }, 1200);
  }

  // Load initial data on page load
  window.addEventListener('load', fetchPrices);
</script>
{% endblock %}