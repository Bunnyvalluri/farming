{% extends "base.html" %}

{% block head %}
<!-- React and ReactDOM via CDN for modern professional UI -->
<script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<!-- Babel for in-browser JSX compilation -->
<script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
{% endblock %}

{% block content %}
<div id="react-market-root"></div>

<script type="text/babel">
  const { useState, useEffect } = React;

  const MarketDashboard = () => {
    const [state, setState] = useState('Maharashtra');
    const [crop, setCrop] = useState('Wheat');
    const [loading, setLoading] = useState(false);
    const [marketData, setMarketData] = useState([]);

    const statesList = ['Maharashtra', 'Punjab', 'Uttar Pradesh', 'Andhra Pradesh', 'Telangana'];
    const cropsList = ['Wheat', 'Rice', 'Cotton', 'Soybean', 'Corn'];

    const basePrices = {
      "Wheat": 2200, "Rice": 3100, "Cotton": 7000, "Soybean": 5500, "Corn": 2000
    };

    const fetchPrices = () => {
      setLoading(true);
      // Simulate API call latency for realistic feel
      setTimeout(() => {
        const basePrice = basePrices[crop];
        const mandis = [`${state} Central`, `${state} North`, `${state} East`];

        const newData = mandis.map(mandiName => {
          const minP = Math.floor(basePrice * (0.9 + Math.random() * 0.1));
          const maxP = Math.floor(basePrice * (1.1 + Math.random() * 0.1));
          const isUp = Math.random() > 0.5;
          return {
            id: mandiName,
            mandi: `${mandiName} APMC`,
            commodity: crop,
            quality: 'FAQ / A-Grade',
            minPrice: minP,
            maxPrice: maxP,
            isUp: isUp,
            trendVal: Math.floor(Math.random() * 5) + 1
          };
        });

        setMarketData(newData);
        setLoading(false);
        if (typeof showToast === 'function') {
          showToast('Market prices automatically synced via React UI', 'success');
        }
      }, 750);
    };

    useEffect(() => {
      fetchPrices();
    }, []); // Initial load

    return (
      <div className="pt-8 pb-24 px-4 sm:px-6 lg:px-8 font-sans">
        <div className="max-w-6xl mx-auto space-y-10">

          {/* Header Title Section */}
          <div className="text-center space-y-4">
            <h2 className="text-4xl md:text-5xl font-extrabold text-emerald-900 tracking-tight flex justify-center items-center gap-4">
              <div className="bg-emerald-100 text-emerald-600 w-16 h-16 rounded-2xl flex items-center justify-center shadow-inner">
                <i className="fa-solid fa-chart-line text-3xl"></i>
              </div>
              Real-Time Market Prices
            </h2>
            <p className="text-lg text-emerald-700/80 max-w-2xl mx-auto font-medium">
              Track live APMC Mandi rates, analyze market trends, and make profitable selling decisions through our Interactive React Dashboard.
            </p>
          </div>

          {/* Controls Bar (Glassmorphism + Tailwind) */}
          <div className="bg-white/80 backdrop-blur-xl p-5 rounded-3xl shadow-xl shadow-emerald-900/5 border border-white flex flex-col md:flex-row items-center justify-center gap-5 transition-all">

            <div className="relative group w-full md:w-auto">
              <div className="absolute inset-y-0 left-0 pl-5 flex items-center pointer-events-none text-emerald-500">
                <i className="fa-solid fa-map-location-dot"></i>
              </div>
              <select
                value={state}
                onChange={(e) => setState(e.target.value)}
                className="w-full md:w-72 pl-12 pr-4 py-4 bg-gray-50/50 hover:bg-emerald-50/50 border-2 border-transparent rounded-2xl text-gray-700 font-bold focus:outline-none focus:border-emerald-500 transition-all appearance-none cursor-pointer"
              >
                {statesList.map(s => <option key={s} value={s}>{s}</option>)}
              </select>
              <div className="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none text-gray-400">
                <i className="fa-solid fa-chevron-down text-xs"></i>
              </div>
            </div>

            <div className="relative group w-full md:w-auto">
              <div className="absolute inset-y-0 left-0 pl-5 flex items-center pointer-events-none text-emerald-500">
                <i className="fa-solid fa-seedling"></i>
              </div>
              <select
                value={crop}
                onChange={(e) => setCrop(e.target.value)}
                className="w-full md:w-72 pl-12 pr-4 py-4 bg-gray-50/50 hover:bg-emerald-50/50 border-2 border-transparent rounded-2xl text-gray-700 font-bold focus:outline-none focus:border-emerald-500 transition-all appearance-none cursor-pointer"
              >
                {cropsList.map(c => <option key={c} value={c}>{c}</option>)}
              </select>
              <div className="absolute inset-y-0 right-0 pr-4 flex items-center pointer-events-none text-gray-400">
                <i className="fa-solid fa-chevron-down text-xs"></i>
              </div>
            </div>

            <button
              onClick={fetchPrices}
              disabled={loading}
              className="w-full md:w-auto px-10 py-4 bg-emerald-600 hover:bg-emerald-500 active:scale-95 text-white font-bold rounded-2xl shadow-lg shadow-emerald-600/30 transition-all flex items-center justify-center gap-3 group disabled:opacity-70 disabled:active:scale-100 border border-emerald-400/50 text-lg"
            >
              {loading ? <i className="fa-solid fa-spinner fa-spin text-xl"></i> : <i className="fa-solid fa-rotate-right group-hover:rotate-180 transition-transform duration-500 text-xl"></i>}
              {loading ? 'Fetching APMC Base...' : 'Check Live Prices'}
            </button>
          </div>

          {/* Data Table */}
          <div className="bg-white rounded-3xl shadow-xl shadow-gray-200/50 border border-gray-100 overflow-hidden relative transition-all duration-300">
            {loading && (
              <div className="absolute inset-0 bg-white/70 backdrop-blur-[3px] z-10 flex items-center justify-center transition-all duration-300">
                <div className="flex flex-col items-center gap-4 text-emerald-600 bg-white px-8 py-6 rounded-3xl shadow-2xl border border-emerald-100">
                  <i className="fa-solid fa-circle-notch fa-spin text-5xl"></i>
                  <span className="font-extrabold tracking-widest text-sm uppercase text-gray-800">Processing Live Data...</span>
                </div>
              </div>
            )}

            <div className="overflow-x-auto">
              <table className="w-full text-left border-collapse">
                <thead>
                  <tr className="bg-emerald-900 text-white">
                    <th className="px-8 py-6 font-bold uppercase tracking-wider text-sm rounded-tl-3xl">Market / Mandi APMC</th>
                    <th className="px-8 py-6 font-bold uppercase tracking-wider text-sm">Commodity</th>
                    <th className="px-8 py-6 font-bold uppercase tracking-wider text-sm">Quality Mark</th>
                    <th className="px-8 py-6 font-bold uppercase tracking-wider text-sm">Min Price (₹)</th>
                    <th className="px-8 py-6 font-bold uppercase tracking-wider text-sm">Max Price (₹)</th>
                    <th className="px-8 py-6 font-bold uppercase tracking-wider text-sm rounded-tr-3xl">Active Trend</th>
                  </tr>
                </thead>
                <tbody className="divide-y divide-gray-100">
                  {marketData.map((data, idx) => (
                    <tr key={data.id} className="hover:bg-emerald-50/50 transition-colors group">
                      <td className="px-8 py-6 whitespace-nowrap">
                        <div className="flex items-center gap-4">
                          <div className="w-10 h-10 rounded-xl bg-emerald-100 text-emerald-700 flex items-center justify-center text-sm font-black shadow-sm group-hover:bg-emerald-600 group-hover:text-white transition-colors">
                            {idx + 1}
                          </div>
                          <div>
                            <span className="font-extrabold text-gray-900 block text-lg">{data.mandi}</span>
                            <span className="text-xs font-bold text-gray-400 uppercase tracking-wider">{state}</span>
                          </div>
                        </div>
                      </td>
                      <td className="px-8 py-6 whitespace-nowrap">
                        <span className="inline-flex items-center px-4 py-2 rounded-xl text-sm font-bold bg-amber-50 text-amber-700 border border-amber-200 shadow-sm">
                          <i className="fa-solid fa-wheat-awn mr-2 opacity-50"></i>
                          {data.commodity}
                        </span>
                      </td>
                      <td className="px-8 py-6 whitespace-nowrap">
                        <span className="bg-gray-100 text-gray-600 px-3 py-1.5 rounded-lg text-sm font-bold">
                          {data.quality}
                        </span>
                      </td>
                      <td className="px-8 py-6 whitespace-nowrap">
                        <span className="text-gray-500 font-bold font-mono text-lg bg-gray-50 px-3 py-1 rounded-lg">₹{data.minPrice}</span>
                      </td>
                      <td className="px-8 py-6 whitespace-nowrap">
                        <span className="text-emerald-700 font-extrabold font-mono text-2xl flex items-center gap-1">
                          <span className="text-emerald-400 text-lg">₹</span>{data.maxPrice}
                        </span>
                      </td>
                      <td className="px-8 py-6 whitespace-nowrap">
                        {data.isUp ? (
                          <div className="flex items-center justify-center gap-2 text-emerald-700 font-bold bg-emerald-100/80 px-4 py-2 rounded-xl w-max border border-emerald-200">
                            <i className="fa-solid fa-arrow-trend-up"></i>
                            <span className="text-lg">+{data.trendVal}%</span>
                          </div>
                        ) : (
                          <div className="flex items-center justify-center gap-2 text-red-600 font-bold bg-red-50 px-4 py-2 rounded-xl w-max border border-red-100">
                            <i className="fa-solid fa-arrow-trend-down"></i>
                            <span className="text-lg">-{data.trendVal}%</span>
                          </div>
                        )}
                      </td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>

            <div className="bg-gray-50 border-t border-gray-100 p-4 text-center">
              <p className="text-sm text-gray-500 font-medium">
                <i className="fa-solid fa-clock mr-1 text-emerald-500"></i> APMC data last synced a few moments ago via React.js UI state
              </p>
            </div>
          </div>
        </div>
      </div>
    );
  };

  const root = ReactDOM.createRoot(document.getElementById('react-market-root'));
  root.render(<MarketDashboard />);
</script>
{% endblock %}