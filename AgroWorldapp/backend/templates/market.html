{% extends "base.html" %}

{% block content %}
<div class="min-h-screen bg-slate-50">

  <!-- Page Header -->
  <div class="bg-white border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-6">
        <div>
          <div class="flex items-center gap-3 mb-3">
            <span
              class="inline-flex items-center gap-2 px-3 py-1 bg-emerald-50 text-emerald-700 text-xs font-semibold rounded-full border border-emerald-200">
              <span class="w-1.5 h-1.5 bg-emerald-500 rounded-full animate-pulse"></span>
              Live
            </span>
            <span class="text-xs text-slate-400 font-medium uppercase tracking-wider">Agricultural Commodity
              Exchange</span>
          </div>
          <h1 class="text-3xl font-bold text-slate-900 tracking-tight">
            {{ page_title }}
          </h1>
          <p class="mt-1 text-slate-500 text-sm">
            Real-time prices tracked across major commodity exchanges in India.
          </p>
        </div>
        <div
          class="flex items-center gap-2 text-sm text-slate-500 bg-slate-50 px-4 py-2.5 rounded-xl border border-slate-200">
          <i class="fa-regular fa-clock text-slate-400"></i>
          <span data-key="market_last_sync">Last Updated:</span>
          <span id="syncTime" class="font-semibold text-slate-700">â€”</span>
        </div>
      </div>
    </div>
  </div>

  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

    <!-- Filter Card -->
    <div class="bg-white rounded-2xl border border-slate-200 p-6 mb-6 shadow-sm">
      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
        <!-- Region Select -->
        <div>
          <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2"
            data-key="market_label_region">
            State / Region
          </label>
          <div class="relative">
            <select id="stateSelect"
              class="w-full appearance-none bg-slate-50 border border-slate-200 text-slate-800 font-medium rounded-xl px-4 py-3 pr-10 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all cursor-pointer">
              <option value="Maharashtra" data-key="state_mh">Maharashtra</option>
              <option value="Punjab" data-key="state_pb">Punjab</option>
              <option value="Uttar Pradesh" data-key="state_up">Uttar Pradesh</option>
              <option value="Andhra Pradesh" data-key="state_ap">Andhra Pradesh</option>
              <option value="Telangana" data-key="state_ts">Telangana</option>
            </select>
            <i
              class="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none"></i>
          </div>
        </div>

        <!-- Commodity Select -->
        <div>
          <label class="block text-xs font-semibold text-slate-500 uppercase tracking-wider mb-2"
            data-key="market_label_comm">
            Commodity
          </label>
          <div class="relative">
            <select id="cropSelect"
              class="w-full appearance-none bg-slate-50 border border-slate-200 text-slate-800 font-medium rounded-xl px-4 py-3 pr-10 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-all cursor-pointer">
              <option value="Wheat">Wheat</option>
              <option value="Rice">Rice</option>
              <option value="Cotton">Cotton</option>
              <option value="Soybean">Soybean</option>
              <option value="Corn">Corn</option>
            </select>
            <i
              class="fa-solid fa-chevron-down absolute right-4 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none"></i>
          </div>
        </div>

        <!-- Fetch Button -->
        <button onclick="fetchPrices()"
          class="flex items-center justify-center gap-2 w-full bg-primary-600 hover:bg-primary-700 text-white font-semibold rounded-xl px-6 py-3 transition-all shadow-sm hover:shadow-md active:scale-95">
          <i class="fa-solid fa-rotate text-sm"></i>
          <span data-key="market_btn_update">Update Prices</span>
        </button>
      </div>
    </div>

    <!-- Table Card -->
    <div class="bg-white rounded-2xl border border-slate-200 shadow-sm overflow-hidden">

      <!-- Loading State -->
      <div id="loadingState" class="hidden py-20 text-center">
        <div class="flex flex-col items-center gap-4 max-w-xs mx-auto">
          <div class="relative w-12 h-12">
            <div class="absolute inset-0 border-4 border-slate-100 rounded-full"></div>
            <div class="absolute inset-0 border-4 border-t-primary-600 rounded-full animate-spin"></div>
          </div>
          <div class="space-y-2">
            <p id="loadingStatusText" class="text-sm font-semibold text-slate-700" data-key="market_loading">Fetching
              live prices...</p>
            <div class="w-48 h-1.5 bg-slate-100 rounded-full overflow-hidden mx-auto">
              <div id="loadingProgressBar" class="h-full bg-primary-500 w-0 transition-all duration-500 rounded-full">
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Data Table -->
      <div class="overflow-x-auto">
        <table class="w-full text-sm min-w-[700px]">
          <thead>
            <tr class="border-b border-slate-200 bg-slate-50/80">
              <th class="text-left px-6 py-4 text-xs font-semibold text-slate-500 uppercase tracking-wider"
                data-key="market_th_mandi">
                Exchange / Market
              </th>
              <th class="text-left px-6 py-4 text-xs font-semibold text-slate-500 uppercase tracking-wider"
                data-key="market_th_comm">
                Commodity
              </th>
              <th class="text-left px-6 py-4 text-xs font-semibold text-slate-500 uppercase tracking-wider"
                data-key="market_th_var">
                Grade / Variety
              </th>
              <th class="text-right px-6 py-4 text-xs font-semibold text-slate-500 uppercase tracking-wider"
                data-key="market_th_price">
                Price (â‚¹/Quintal)
              </th>
              <th class="text-right px-6 py-4 text-xs font-semibold text-slate-500 uppercase tracking-wider"
                data-key="market_th_trend">
                Trend
              </th>
            </tr>
          </thead>
          <tbody id="priceTableBody" class="divide-y divide-slate-100">
            <!-- JS Injected -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- Summary Footer -->
    <div class="mt-4 flex flex-wrap gap-4 text-xs text-slate-400 items-center justify-between">
      <span>ðŸ“Š Prices indicative. Source: APMC India aggregated data.</span>
      <span class="flex items-center gap-1.5"><i class="fa-solid fa-shield-halved text-emerald-500"></i> Data integrity
        verified</span>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
  function fetchPrices() {
    const state = document.getElementById('stateSelect').value;
    const crop = document.getElementById('cropSelect').value;
    const tbody = document.getElementById('priceTableBody');
    const loading = document.getElementById('loadingState');
    const statusText = document.getElementById('loadingStatusText');
    const progressBar = document.getElementById('loadingProgressBar');

    tbody.innerHTML = '';
    loading.classList.remove('hidden');
    progressBar.style.width = '0%';

    setTimeout(() => { statusText.innerText = 'Connecting to exchange nodes...'; progressBar.style.width = '35%'; }, 200);
    setTimeout(() => { statusText.innerText = 'Aggregating market data...'; progressBar.style.width = '75%'; }, 600);

    setTimeout(() => {
      progressBar.style.width = '100%';
      loading.classList.add('hidden');

      const basePrice = { Wheat: 2200, Rice: 3100, Cotton: 7000, Soybean: 5500, Corn: 2000 }[crop];

      const stateHubs = {
        'Maharashtra': [{ hub: 'Pune Commodity Exchange', code: 'PCX' }, { hub: 'Nashik Agri Terminal', code: 'NAT' }, { hub: 'Mumbai Trade Centre', code: 'MTC' }],
        'Punjab': [{ hub: 'Amritsar Grain Exchange', code: 'AGE' }, { hub: 'Ludhiana Commodity Hub', code: 'LCH' }, { hub: 'Patiala Agri Market', code: 'PAM' }],
        'Uttar Pradesh': [{ hub: 'Lucknow Agri Exchange', code: 'LAE' }, { hub: 'Kanpur Grain Terminal', code: 'KGT' }, { hub: 'Agra Commodity Centre', code: 'ACC' }],
        'Andhra Pradesh': [{ hub: 'Vijayawada Agri Bourse', code: 'VAB' }, { hub: 'Guntur Commodity Market', code: 'GCM' }, { hub: 'Kurnool Trade Terminal', code: 'KTT' }],
        'Telangana': [{ hub: 'Hyderabad Grain Exchange', code: 'HGE' }, { hub: 'Warangal Agri Market', code: 'WAM' }, { hub: 'Nizamabad Trade Hub', code: 'NTH' }],
      };

      const hubs = stateHubs[state] || stateHubs['Maharashtra'];
      const grades = ['Grade A Premium', 'Hybrid FAQ', 'Eco Certified'];

      hubs.forEach((h, i) => {
        const minP = Math.floor(basePrice * (0.93 + Math.random() * 0.08));
        const maxP = Math.floor(basePrice * (1.05 + Math.random() * 0.12));
        const isUp = Math.random() > 0.45;
        const grade = grades[i];

        const row = document.createElement('tr');
        row.className = 'hover:bg-slate-50 transition-colors';
        row.innerHTML = `
          <td class="px-6 py-4">
            <div class="flex items-center gap-3">
              <div class="w-9 h-9 rounded-lg bg-primary-50 text-primary-600 flex items-center justify-center shrink-0">
                <i class="fa-solid fa-building-columns text-sm"></i>
              </div>
              <div>
                <div class="font-semibold text-slate-800 text-sm">${h.hub}</div>
                <div class="text-xs text-slate-400 font-mono">${h.code} Â· APMC</div>
              </div>
            </div>
          </td>
          <td class="px-6 py-4">
            <span class="inline-flex items-center gap-1.5 px-2.5 py-1 bg-slate-100 text-slate-600 rounded-lg text-xs font-medium">
              <i class="fa-solid fa-seedling text-primary-500"></i>
              ${crop}
            </span>
          </td>
          <td class="px-6 py-4 text-sm text-slate-600 font-medium">${grade}</td>
          <td class="px-6 py-4 text-right">
            <div class="font-bold text-slate-900 text-base">â‚¹${maxP.toLocaleString()}</div>
            <div class="text-xs text-slate-400">â‚¹${minP.toLocaleString()} min</div>
          </td>
          <td class="px-6 py-4 text-right">
            <span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-lg text-xs font-semibold
              ${isUp ? 'bg-emerald-50 text-emerald-700' : 'bg-rose-50 text-rose-700'}">
              <i class="fa-solid ${isUp ? 'fa-arrow-trend-up' : 'fa-arrow-trend-down'} text-[10px]"></i>
              ${isUp ? 'Rising' : 'Dipping'}
            </span>
          </td>
        `;
        tbody.appendChild(row);
      });

      document.getElementById('syncTime').innerText = new Date().toLocaleTimeString();
      showToast('Prices updated successfully.', 'success');
    }, 1200);
  }

  window.addEventListener('load', fetchPrices);
</script>
{% endblock %}